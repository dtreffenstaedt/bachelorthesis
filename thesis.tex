% !TeX spellcheck = en_GB
\documentclass[abstract,toc,los,lof,english,10pt,glossary,acronyms]{jluthesis}

\usepackage{listings}
\usepackage{float}
\newfloat{lstfloat}{tb}{lop}
\floatname{lstfloat}{Listing}


\usepackage{caption}
\usepackage{subcaption}
\renewcommand\thesubfigure{-\arabic{subfigure}}


\usepackage{pdfpages}
\input{data/glossaries.tex}
\bibliography{data/thesis.bib}

\topic{Real-time data analysis of a distributed muon detector network for cosmic shower detection and reconstruction}
\title[Bachelor Thesis]{Bachelor Thesis}
\author[Daniel Treffenstädt]{Daniel J.S. Treffenstädt}
\matnr{6067797}
\reviewer{Prof. Dr. Kai-Thomas Brinkmann\\apl. Prof. Dr. Sören Lange}
\supervisor{Dr. Hans-Georg Zaunick}



\begin{document}
\input{data/definitions.tex}

	
\makebeginning{
	Extensive Air Showers produced by ultra high energy cosmic radiation is still an active area of research. Due to the low number of such events collecting statistics is not a simple task. There are many approaches to collecting enough data about these air showers. One such approach is the usage of a distributed network of low-cost particle detectors which can be operated by persons outside the university environment.
	
	In this thesis, a method is developed to perform real-time analysis for a network of low-cost plastic scintillator detectors. This network consists of small scintillator detectors with silicon Photomultiplier units which are attached to a Raspberry-Pi computer. Those detection units are located throughout Germany and send their data to a server where it is continuously monitored for coincidences.
	
	An approach to reconstructing the possible incident direction of the primary particle as well as an approximation for plausible energies is presented.
}
\includepdf[noautoscale=true, width=\paperwidth]{data/selbststaendigkeit.pdf}


\section{Introduction}
\subsection{Cosmic Radiation}
\acrfull{uhecr} is cosmic radiation with energy in the range of $10^{18}$\,eV to $10^{20}$\,eV.\footnote{The energy unit eV(Electron-Volt) describes the kinetic energy a unit charge holds after being accelerated through an electric field for 1V. It is equivalent to $1.602176634\cdot10^{-19}\,\text{J}$.}
Cosmic radiation has been discovered in 1912 by Viktor Hess by performing measurements with three electrometers in a balloon flight. He measured the energy flux in the atmosphere and showed that it increased with altitude. This is explained by secondary particles which are produced through the interaction of primary cosmic radiation with the atmosphere. The cosmic radiation is produced by many different sources, one of which is our sun. The sun however only produces cosmic radiation up to a few hundred MeV of energy through coronal mass ejections and other processes and so is not contributing to \acrshort{uhecr}. Higher energy sources include other stars, supernovae and also accretion disks around black holes. Though the production mechanism for the highest energy sources are still not fully understood and no sources have been identified definitively. Research at the Pierre-Auger observatory though shows an anisotropy in the arrival directions and suggests various sources \cite{fargion2018ultra}.
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.5\linewidth]{data/uhecr-sources}
	\caption{Possible souces of \acrshort{uhecr} \cite{fargion2018ultra}}
	\label{fig:uhecr-sources}
\end{figure} \\
The spectrum of this cosmic radiation is shown in figure \ref{fig:cr_spectrum}.
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.75\linewidth]{data/cr_spectrum}
	\caption{Spectrum of cosmic radiation \cite{evoli_carmelo_2020_4396125}}
	\label{fig:cr_spectrum}
\end{figure} \\
There, measurements from different experiments are shown. The y axis shows the energy flux of cosmic rays in units of energy per second per square meter per solid angle $\frac{\text{GeV}}{\text{m}^2\cdot\text{s}\cdot\text{sr}}$. The x axis shows the primary energy of the cosmic rays, for comparison the upper axis shows the energy in units of Joule, the lower axis shows it in units of electron-Volt. Notable here is the much higher number of protons as compared to all other particles by two orders of magnitude. This allows one to make the reasonable assumption that most cosmic rays are protons. Energies above the labelled knee originate almost exclusively from extragalactic sources.


One interesting observation is that the proton spectrum does not have a solid cutoff at $5\cdot10^{19}$\,eV of energy, rather it extends beyond it. This value is significant because it is calculated to be the \acrfull{gzkl}\cite{2021APh...12602526B}. This limit stems from high energy protons interacting with the microwave background radiation thus being lifted into an excited state which can decay.
\begin{equation}\label{eq:gzkl}
	\begin{aligned}
		\gamma + p &\rightarrow \Delta^+ &\rightarrow p + \pi^0 \\
		\gamma + p &\rightarrow \Delta^+ &\rightarrow n + \pi^+
	\end{aligned}
\end{equation}
Equation \ref{eq:gzkl} descibes the possible interaction between the microwave background photons and protons. In both cases, the proton gets excited to a $\Delta^+$ resonance state, which can decay to a hadron and a pi meson. One possible decay product is a proton and a $\pi^0$, the other one a neutron and a $\pi^+$. Though this process, the proton loses roughly $20\,\%$ of its energy, since the energy prior to the interaction gets transferred to both resulting particles according to their relative masses. Should the proton then remain above the limit, the same interaction can take place again. It is unlikely that any proton at these energies can travel more than $100\,\cdot10^6\,\text{ly}$ without undergoing this interaction. Since most particles above the ankle in the proton specturm shown in figure \ref{fig:cr_spectrum} are of extragalactic origin, this means that virtually all protons with these high energies must have undergone this interaction, dropping them below the \acrshort{gzkl}.
The violation of this limit could be explained with a proposition by the Pierre Auger Observatory that most \acrshort{uhecr} are in fact heavier nuclei than single protons \cite{thepierreaugercollaboration2017inferences}.


The production mechanisms are not yet fully understood, though one possible mechanism involves active galaxy cores.
These are super massive black holes at the centre of galaxies which feature an accretion disk. In the case of such a disk, a neutral particle can be on a decaying orbit which ends close to the Schwarzschild radius. At that point the effective electric charge due to the rotation of the black hole and its magnetic fields dominates and ionises the particle. The now positively charged particle gets accelerated to the highest energies and follows a spiral trajectory along the spin axis of the black hole.\cite{Tursunov_2020}
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.5\linewidth]{data/uhecr-sm-bh}
	\caption{Trajectory of neutral particle around supermassive black hole \cite{Tursunov_2020}}
	\label{fig:uhecr-sm-bh}
\end{figure}\\

\subsection{Cosmic Air Showers}\label{subsec:airshowers}
When a cosmic ray hits the atmosphere, it interacts with the nucleons of the different molecules in air. Due to the relative abundance, it is most likely that the first interaction takes place between the primary particle and a Neutrogen nucleus. This causes interactions described by Quantum Chromo dynamics which is beyond the scope of this thesis. This interaction leaves nucelar fragments and $\pi$ mesons behind which can then interact with other air molecules again or - in the case of pions - decay. This creates a cascade of particles which continue along the trajectory towards the surface of earth. A picture of an air shower produced by a primary proton is shown in figure \ref{fig:proton-shower}. This image is produced at the KIT with the simulation toolkit CORSIKA.
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.8\linewidth]{data/shower-45}
	\caption{Proton Air Shower \cite{corsika-images}}
	\label{fig:proton-shower}
\end{figure} \\

The secondary particles can be divided into three different components, they are shown in figure \ref{fig:shower-components}.
As seen in this figure, neutral Pions $\pi^0$ can decay to two photons $\gamma$ or an electron positron pair and a photon. The decay cross section for the two gamma production is much higher than that of the $e^\pm + \gamma$ production though, resulting in probabilities of roughly $99$ and $1\,\%$. 
\begin{equation}
	\begin{aligned}
		\pi^0 &\rightarrow 2\gamma \\
		\pi^0 &\rightarrow e^+ + e^- + \gamma \\
	\end{aligned}
\end{equation}
The produced photons can then undergo pair production through which a lepton - anti lepton pair is produced. For this to occur, the photon needs to have an energy higher than twice the rest mass of the lepton. In the case of an electron positron pair, the rest energy is $511\,\text{keV}$ resulting in a minimum photon energy of $1022\,\text{keV}$. Any energy above this limit gets distributed evenly across both resulting particles as kinetic energy. In the \acrfull{com} system due to conservation of impulse, the pair travels in opposite directions to each other in a 90 degree angle to the original photon. In the laboratory system however, the resulting particles continue along the original trajectory.

Should the photon not have enough energy to produce a pair, it can be absorbed in an atom by raising the energy level of an electron in the shell or loose energy through Compton scattering.\\
In the case of a charged pion $\pi^\pm$, The most likely decay with a probability of $99.9\,\%$ is to a muon $\mu^\pm$ and a muon-neutrino $\nu_\mu$. The interaction is shown in equation \ref{eq:piondecay}.
\begin{equation}\label{eq:piondecay}
	\begin{aligned}
		\pi^+ &\rightarrow \mu^+ + \nu_\mu \\
		\pi^- &\rightarrow \mu^- + \bar{\nu}_\mu
	\end{aligned}
\end{equation}
\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}
		\draw[->] (0,0.5) node[above] {primary particle} -- ++(0,-1.5) coordinate(primary);
		\draw[->] (primary) -- ++(-175:1.5) node[above] {$\pi^0$} -- ++(-175:2) coordinate (pi0);
		\draw[->] (primary) -- ++(-105:1) node[left] {$\pi^\pm$} -- ++(-105:1.5) coordinate (pipm);
		\draw[->] (primary) -- ++(-35:1) -- ++ (-35:2) coordinate (zn);
		
		\draw[->] (pi0) -- ++(-160:1) coordinate(gamma) node[above right] {$\gamma$};
		\draw[->] (pi0) -- ++(-130:1) node[below right] {$\gamma$};
		\draw[->] (gamma) -- ++(-165:1) node[above] {$e^\pm$};
		\draw[->] (gamma) -- ++(-155:1) node[below] {$e^\mp$};
		
		\draw[->] (pipm) -- ++(-110:1) node[left] {$\mu^\pm$};
		
		\draw[->] (zn) -- ++(-10:1) node[above] {p};
		\draw[->] (zn) -- ++(-30:1) node[below] {n};
		
		\draw[thin, dashed] (-2,0) -- ++(0,-5) ++ (-0.5,0) node[left] {Electromagnetic};
		\draw[thin, dashed] (2,0) -- ++(0,-5) ++(-1,0) node[left] {Muonic} ++(1.5,0) node[right] {Hadronic};
	\end{tikzpicture}
	\caption{Components of a cosmic air shower}
	\label{fig:shower-components}
\end{figure}
The figure does not show all interactions, nor does it show the Neutrinos produced through the different interactions.
The shower impact is dependent on the type of primary particle and its energy. In the case of \acrshort{uhecr}, the showers are classified as \acrfull{eas}.
\clearpage
A different interaction of \acrshort{uhecr} with the atmosphere is the Cherenkov radiation. Due to the highly relativistic energies of the particles they travel faster than the local speed of light. In order to calculate the velocity of the particle, the relationship in Equation \ref{eq:lorentz-betagamma} can be used and solved for $\beta=\frac{v}{c_0}$.
\begin{equation} \label{eq:lorentz-betagamma}
	\beta\frac{1}{\sqrt{1 - \beta^2}} = \beta\gamma = \frac{E_{kin}}{E_{rest}}
\end{equation}
\begin{equation}
	\beta=\frac{1}{\sqrt{1 + \left(\frac{E_{rest}}{E_{kin}}\right)^2}}
\end{equation}

In the example of the Oh-My-God particle with an energy of $3.2\cdot10^{20}\,\text{eV}$ which is assumed to have been a proton with a rest energy of $\approx938.272\,\text{MeV}$, this calculates to
\begin{equation}
	\frac{E_{kin}}{E_{rest}} = \frac{3.2\cdot10^{20}\,\text{eV}}{938.27208816\,\text{MeV}}
\end{equation}
\begin{equation}
	\beta=\frac{1}{\sqrt{1 + 8.597212025587174\cdot10^{-24}}}\approx1.
\end{equation}
Given the refractive index of Air of $n\approx1.00028$ for visible light, the particle travels faster than the local speed of light. This causes light in the UV spectrum to be emitted comparable to a Mach cone in situations where an object travels faster than the speed of sound in a medium.
\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}
		\draw[->] (0,0) -- ++(1,0) node[above left] {$v$};
		\draw (0,0) -- ++(7,0) coordinate (tip);
		
		\draw (tip) -- ++(135:4) -- ++(-135:2) coordinate(top) -- ++(-135:2);
		\draw[->,decorate, decoration=snake] (tip) ++(135:1.0) -- ++(45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(135:1.5) -- ++(45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(135:2.0) -- ++(45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(135:2.5) -- ++(45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(135:3.0) -- ++(45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(135:3.5) -- ++(45:1);
		
		\draw (tip) -- ++(-135:4) -- ++(135:4);
		\draw[->,decorate, decoration=snake] (tip) ++(-135:1.0) -- ++(-45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(-135:1.5) -- ++(-45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(-135:2.0) -- ++(-45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(-135:2.5) -- ++(-45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(-135:3.0) -- ++(-45:1);
		\draw[->,decorate, decoration=snake] (tip) ++(-135:3.5) -- ++(-45:1);
		
		\draw[<->] (top) arc(45:22.5:2) coordinate(theta) arc(22.5:0:2);
		\node[below left] at (theta) {$\theta$};
	\end{tikzpicture}
	\caption{Geometry of cherenkov radiation.}
	\label{fig:cherenkov}
\end{figure}\\
The angle $\theta$ can be calculated through the relation $\cos\left(\theta\right)=\frac{1}{n\beta}$
\clearpage
\subsection{Detection methods}

The detection of \acrshort{uhecr} can be done through three main methods.\\
Two depend on the cosmic air showers described in the section \ref{subsec:airshowers}, namely the muonic and the electromagnetic component. The other method depends on the Cherenkov radiation.
In the case of Cherenkov radiation, UV telescopes can be used to detect the UV light directly. By observing the same source through multiple locations, the origin can be reconstructed. 
A popular example of a particle being detected through these means is the so called Oh-My-God particle, likely a proton or heavier nucleus with an energy of  $3.2\pm0.9\cdot10^{20}\,\text{eV}$ of energy. This particular particle is interesting since it was the first particle to exceed the \acrshort{gzkl}. It has been detected by the HiRes detector in Utah.

A method using the electromagnetic component of a cosmic air shower exploits the fact that the frequencies lie in the radio range\cite{NELLES201513} and can be detected through normal radio Antennae\cite{SCHRODER20171}. Due to the polarisation of the radio signal, often multiple antennae with different polarisation characteristics are used.


\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}[->]
		\draw (0,0) rectangle++(8,1);
		\draw (0,-3) rectangle++(8,-1);
		
		\draw (1,-3.5) -- ++(0,2) node[right] {excitation} -- ++(0,2);
		
		\draw (1.5,0.25) -- ++(2,0) node [above] {transport} -- ++(2,0);
		
		\draw[-] (6,-0.5) -- ++(0.5,0);
		\draw[-] (6.5,-2) -- ++(-0.5,0) node [left] {trap};
		
		\draw (6.25,0.5) -- ++(0,-1);
		\draw (6.25,-0.5) -- ++(0,-0.75) coordinate(emission) -- ++(0,-0.75);
		\draw (6.25,-2) -- ++(0,-1.5);
		
		\draw[decorate, decoration=snake] (emission) -- ++(30:3) node [above] {$\gamma$};
		\node[below right] at (emission) {emission};
		
		
		\node[left] at (0,0.5) {Conduction};
		\node[left] at (0,-3.5) {Valence};
	\end{tikzpicture}
	\caption{Mechanism for crystal scintillators}
	\label{fig:scintillator}
\end{figure}
Another method is to detect the muonic component, this can be done through Scintillator detectors. Due to the muon being a charged particle, it interacts with matter and deposits energy. Certain materials can give off this energy via photons, a process which is known as scintillation. Figure \ref{fig:scintillator} shows the mechanism through which scintillation occurs. First, an electron is excited from the valence band into the conduction band through energy deposit from an incident particle. This electron then is transported through the conduction band where it can drop back down to the valence band. Though if it dropped back directly, a photon would be emitted which could immediatly excit another electron in the valence band. What makes scintillators special is the existance of traps which reduce the energy of the emitted photons. Those photons then do not have enough energy to excite eletrons in the material so they can pass through it. With the use of a photmultiplier, the emitted photons can then be detected. One type of Photomultiplier is the \acrfull{sipm}, which is an array of single-photon avalanche diode which are photodiodes operating above the reverse-bias breakover voltage resulting in an avalanche upon interaction with even a single photon. The multiplicity of avalanches then is related to the number of photons interacting with the photomultiplier.

\section{Detectors}
\subsection{Station}
Each detector station consists of a Scintillator with \acrshort{sipm} assembly, a readout board and Raspberry Pi single-board computer and is called a \acrfull{cdu}.
\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		\node [anchor=south west] at (0,0) {\includegraphics[width=0.4\linewidth]{data/station-assembly}};
		
		\draw[fill=black] (4,7) circle(0.1) -- ++(3,-1) node[below right] {Scintillator};
		\draw[fill=black] (1,4.5) circle(0.1) -- ++(-2,1) node[above left] {SiPM};
		\draw[fill=black] (0.75,3.5) circle(0.1) -- ++(-2,0) node[left] {Preamplifier};
		\draw[fill=black] (4,3) circle(0.1) -- ++(3,0) node[right] {Readout board};
	\end{tikzpicture}
	\caption{Detector station assembly without Raspberry Pi computer}
	\label{fig:station_assembly}
\end{figure}
In figure \ref{fig:station_assembly} each component excluding the Raspberry Pi is shown. The SiPM is still detached from the Scintillator for this picture since it would not be visible as separate part otherwise. The preamplifier is part of the SiPM assembly and prepares the signal to the readout board in order to prevent loss of signal over the transmission line. The readout board supports two input channels which can be linked logically either per AND or XOR, though per default only one channel is used.

The readout board uses a ublox NEO GNSS receiver chip which features an interrupt input to accurately timestamp input signals with a maximum resolution of $21\,\text{ns}$ \cite{ublox-datasheet} with a deadtime of $100\,\text{ms}$.
This deadtime makes it unsuitable for high frequency applications though due to the scintillator size of $286.5\,\text{cm}^2$ and an integral intensity of Muons over the whole energy spectrum above $1\,\text{GeV}$ of $1\,\text{cm}^{-2}\text{min}^{-1}$\cite[512]{10.1093/ptep/ptaa104} the expected maximum detection rate of $4.7\,\text{Hz}$ is within the capabilities of this setup. \\

The detector software collects various information in addition to the timestamp with each event and sends it to the server via the \acrfull{mqtt} protocol. This is a text-based protocol providing reliable information transfer with minimal overhead\cite{mqtt}. Additional to the event information the station sends log information in regular intervals indicative of the current state of the detector station.
\subsection{Data exchange format}
\paragraph{Event messages} contain information about the event with additional details about the current state of the detector station. Each message consists of $8$ fields, one of which is part of the \acrshort{mqtt} message topic and $7$ are part of the payload. An example is shown in listing \ref{lst:mqtt-event}, the fields are described in table \ref{tab:event-message}.
\begin{lstfloat}[H]
	\centering
	\begin{verbatim}
		jlu/HBR16Lab105_1 1625745406.606430870 1625745406.606431974 26 13526 1 2 1
	\end{verbatim}
	\caption{Event message format example}
	\label{lst:mqtt-event}
\end{lstfloat}
\begin{table}[H]
	\centering
	\begin{tabular}{| c | c |}
		\hline
		\textbf{Position} & \textbf{Description} \\
		\hline
		$1$ & detector station user and id \\
		\hline
		$2$ & Nanosecond rising edge timestamp \\
		\hline
		$3$ & Nanosecond falling edge timestamp \\
		\hline
		$4$ & Time Accuracy in Nanoseconds \\
		\hline
		$5$ & $16$ bit event counter value from the detector station \\
		\hline
		$6$ & Bitflag for valid GNSS fix \\
		\hline
		$7$ & UTC Time flag \\
		\hline
		$8$ & GNSS time grid flag \\
		\hline
	\end{tabular}
	\caption{Event message field description}
	\label{tab:event-message}
\end{table}


\paragraph{Log messages} contain various information about the current station state and are formatted as shown in Listing \ref{lst:mqtt-log}, the unit field is not present in all log messages. A small excerpt of various log message identifiers is shown in Table \ref{tab:station_logs}.
\begin{lstfloat}[H]
	\centering
	\begin{verbatim}
		jlu/HBR16Lab105_1 <message identifier> <value> [unit]
	\end{verbatim}
	\caption{Log message format}
	\label{lst:mqtt-log}
\end{lstfloat}
\begin{table}[H]
	\centering
	\begin{tabular}{| c | c |}
		\hline
		\textbf{Identifier} & \textbf{Description} \\
		\hline
		\verb*|geoLongitude| & Longitude of the detector station \\
		\hline
		\verb*|geoLatitude| & Latitude of the detector station \\
		\hline
		\verb*|geoHeightMSL| & Vertical height above the reference ellipsoid surface \\
		\hline
		\verb*|geoHorAccuracy| & Horizontal accuracy of the GNSS signal \\
		\hline
		\verb*|geoVertAccuracy| & Vertical accuracy of the GNSS signal \\
		\hline
		\verb*|positionDOP| & Positional dilution of precision\footnotemark \\
		\hline
		\verb*|clockDrift| & Current inherent drift of the internal clock\\
		\hline
		\verb*|timeAccuracy| & Accuracy of the time measurement \\
		\hline
		\verb*|timeDOP| & Time dilution of precision \\
		\hline
	\end{tabular}
	\caption{Excerpt from detector station log message content}
	\label{tab:station_logs}
\end{table}
\footnotetext{\acrfull{dop}: Numerical value for the statistical dispersion of GNSS measurements}
Since the detector network is not at known locations but distributed across multiple cities and countries at different users locations, in order to be able to make attempts at particle reconstruction, the location information is one of the more important information from the log messages. Additionally to this, the accuracy measurement values are used to determine in what state the detector station is in order to be able to judge the data integrity.
\clearpage
\subsection{Network}
All detector stations are part of a larger network of detectors with a central data processor which analyses all incoming event data for possible coincidences. The entire analysis stack is shown in Figure \ref{fig:network-stack}.
\begin{figure}[H]
	\centering
	\begin{tikzpicture}[>=latex, ->]
		\node (scintillator) [draw, process, minimum height=1cm, minimum width=5cm] {Scintillator};
		\node (cdu) [below=of scintillator, draw, process, minimum height=1cm, minimum width=5cm] {Readout board};
		\node (raspi) [below=of cdu, draw, process, minimum height=1cm, minimum width=5cm] {Raspberry Pi};
		
		\node (mqtt) [right=of raspi, draw, process, minimum height=1cm] {MQTT};
		
		\node (server) [right=of mqtt, draw, process, minimum height=1cm, minimum width=5cm] {Server};
		\node (dnp) [above=of server, draw, process, minimum height=1cm, minimum width=5cm] {Network Processor};
		\node (db) [above=of dnp, draw, process, minimum height=1cm, minimum width=5cm] {Database};
		\node (analysis) [above=of db, draw, process, minimum height=1cm, minimum width=5cm] {Further analysis};
		
		\node (shower) [above=of scintillator] {Shower};
		
		\draw (shower) -- (scintillator) node [midway, right] {$\mu$};
		\draw (scintillator) -- (cdu);
		\draw (cdu) -- (raspi);
		\draw (raspi) -- (mqtt);
		\draw (mqtt) -- (server);
		\draw (server) -- (dnp);
		\draw (dnp) -- (db);
		\draw (db) -- (analysis);
	\end{tikzpicture}
	\caption{Detector network analysis stack}
	\label{fig:network-stack}
\end{figure}
A current overview of active and future stations in Europe can be seen in figure \ref{fig:station-overview}, additional stations are located in north America and Australia. 
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{data/detector-stations}
	\caption[Current overview of detector stations]{Current overview of detector stations\cite{muonpi}.\\Red: future stations\\Green: active stations}
	\label{fig:station-overview}
\end{figure}

\subsection{Data}
The shower front shape of a cosmic shower can initially be assumed to be a thick spherical cap with a thickness of $1\,\text{to}\,2\,\text{m}$\cite{grapes-3-2019}. This shape however fluctuates between shower events and measurements range from spherical cap shapes\cite{chitnis-2002} to conical shapes\cite{grapes-3-2019}. The thickness and deviation from the shape of a spherical cap introduce uncertainties in the calculations presented in this thesis in section \ref{sec:reconstruction}.
\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		\fill (0,0) coordinate(det1) circle(0.1) node[above right] {Detector 1};
		\fill (6,0) coordinate(det2) circle(0.1) node[below right] {Detector 2};
		\draw[ultra thick] (det2) ++ (125:1) arc(-55:-35:6.1) arc(-35:-125:6.1) node[left] {$t_1$};
		\draw[ultra thick, dashed] (det2) arc(-55:-35:7.1) arc(-35:-125:7.1) node[left] {$t_2$};
		\path (det2) arc(-55:-70:7.1) coordinate(source);
		\draw[<-, >=latex] (source) -- ++ (110:5) node[left] {propagation direction};
	\end{tikzpicture}
	\caption{Propagation of the shower front}
	\label{fig:data-shape}
\end{figure}
Figure \ref{fig:data-shape} shows the propagation of the shower front in relation to two detectors. Assuming both detectors have a detection efficiency of $100\,\%$, both will show an event at their respective timestamps $t_1$ and $t_2$. The time difference between both measured timestamps can help to reconstruct the direction of propagation, a method how to do this is shown later in this thesis.

Comparing the timestamps of single detector hits can be used to correlate single data points and combine them to coincidences.
\begin{figure}[H]
	\centering
	\begin{subfigure}{\linewidth}
		\caption{Short detector distance}
		\label{fig:histogram-data:close}
		\begin{tikzpicture}
			\begin{axis}[area style, xlabel={$\Delta{t}\,[\text{ns}]$},ylabel={$n$}, xmin=-600,xmax=600,width=\linewidth,height=0.2\textheight]% coordinates
				\addplot+[ybar interval,mark=no] table {data/jluHBR16Lab105_1_jluHBR16Lab105_DoublePaddle.hist};
			\end{axis}
		\end{tikzpicture}
	\end{subfigure}
	\begin{subfigure}{\linewidth}
		\caption{Medium detector distance}
		\label{fig:histogram-data:mid}
		\begin{tikzpicture}
			\begin{axis}[area style, xlabel={$\Delta{t}\,[\text{ns}]$},ylabel={$n$}, xmin=-600,xmax=600,width=\linewidth,height=0.2\textheight]]% coordinates
				\addplot+[ybar interval,mark=no] table {data/CERN1_CERN3.hist};
			\end{axis}
		\end{tikzpicture}
	\end{subfigure}
	\begin{subfigure}{\linewidth}
		\caption{Large detector distance}
		\label{fig:histogram-data:far}
		\begin{tikzpicture}
			\begin{axis}[area style, xlabel={$\Delta{t}\,[\text{ns}]$},ylabel={$n$}, xmin=-100000,xmax=100000,width=\linewidth,height=0.2\textheight]]% coordinates
				\addplot+[ybar interval,mark=no] table {data/simonglm0_mw1cfn0.hist};
			\end{axis}
		\end{tikzpicture}
	\end{subfigure}
	\caption{Coincidence time histograms for various distances}
	\label{fig:histogram-data}
\end{figure}
When recording all coincidence times of one detector pair the different times can be plotted in a histogram. Figure \ref{fig:histogram-data} shows histograms for three different detector pairs with different distances. The plot \ref{fig:histogram-data:close} shows the closest distance of a few meters, plot \ref{fig:histogram-data:mid} a medium distance of roughly $130\,\text{m}$ and plot \ref{fig:histogram-data:far} a distance of $950\,\text{km}$.

The closest distance shows the clearest signal and largest signal-to-noise ratio. However due to the location of both detectors, the GNSS signal is often weak which leads to a broad distribution due to low time resolution.

In the medium distance plot, a still significant signal is visible, though the signal-to-noise ratio is much worse. The lower number of entries is due to the shorter total runtime of this particular detector pair.

The furthest distance plot shows no signal over the random background.

This highlights the relationship between coincidence rate and detector distance as shown in figure \ref{fig:pair-count-rate}. There, a number of experiments have been performed in order to determine the coincidence rates for different distances. A linear fit has been applied to the experimental data.
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{data/pair-count-rate}
	\caption{Relationship between detector pair distance and coincidence rate\cite{muonpi}}
	\label{fig:pair-count-rate}
\end{figure}


\section{Real-time analysis}
In order to detect coincidences from all incoming single data points, each data point has to be compared with all others in order to find all possible combinations. In order to do this, a useful criterium for a coincidence has to be found. A simple approach is to select a fixed maximum time difference which two events can have in order to be counted towards a coincidence. This however is inefficient and leads to large numbers of false positives, since a fixed interval can not perform well for detector combinations with large and short distances at the same time. Due to this a variable distance based criterium is used. For this purpose, the geodetic coordinates of both detector stations are taken and the straight line distance is calculated through \acrfull{enu} coordinates with the WGS84 model. The \acrshort{enu} coordinate system is a right handed local tangent plane carthesian coordinate system $\left(\hat{e}_{East},\hat{e}_{North},\hat{e}_{Up}\right)$ which is used to set different coordinates in relation to each other. The WGS84 model describes the shape of earth as an ellipsoid and provides reference measurements for this shape.
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.7\linewidth]{data/cr_fig5_SeaLevelMuSpectra_09}
	\caption[Muon energy spectrum from vertical and inclined muons at sea level\cite{10.1093/ptep/ptaa104}]{Muon energy spectrum from vertical and inclined \tikz \draw[rotate=45] (0,0) rectangle(0.125,0.125); muons at sea level \cite[512]{10.1093/ptep/ptaa104}}
	\label{fig:muon-energy-spectrum}
\end{figure} \\
With this distance, the time of flight for the speed of light is calculated in order to receive the maximum physically viable time difference for one detector pair. This value however has large uncertainties especially for detector pairs which are close together.

Since there is a constant timing offset of a few nanoseconds for each detector pair which arises through the specific hardware setup, a minimum coincidence window must be defined in order to capture coincidences even for pairs with a large offset. A practical value of $150\,\text{ns}$ has been chosen.
It is also necessary to define an upper window, since the range of muons in air is limited and detector pairs with extremely large distances would create an abnormal and unphysical number of coincidences if left unconstrained. In order to find a useful upper limit for the coincidence window, the maximum possible flight distance for atmospheric muons has to be detemined. For that, the expected maximum range of muons in air is calculated. In order to do that, first a maximum expected energy is determined through the muon energy spectrum at sea level. Figure \ref{fig:muon-energy-spectrum} shows the muon energy spectrum at sea level for two different inclinations. A cutoff value of $10\,\text{TeV}$ is selected to calculate the maximum expected distance in air. Assuming the \acrfull{csda} range for a $10\,\text{TeV}$ muon taken from \cite{muon-range} of $7.634\cdot10^5\,\frac{\text{g}}{\text{cm}^2}$ and assuming standard condition air density of $1.225\,\frac{\text{kg}}{\text{m}^3}$, the maximum expected range of muons at sea level is $62.3\,\text{km}$. That equates to a time of flight of $207.87\,\mu\text{s}$ and thus a coincidence window of larger than that is not useful.
\subsection{Coincidence and plausability determination}\label{sec:coinc-calc}
In order to determine coincidences, each event needs to be checked against all other events which are currently in the event buffer. To determine whether two events contain a coincidence, it is beneficial to calculate a score for each pair as follows:
\begin{equation}\label{eq:coinc_score}
	c = 1 - \frac{|t_1 - t_2|}{t_{tof}}
\end{equation}
In equation \ref{eq:coinc_score} $t_1$ and $t_2$ denote the timestamps of both events and $t_{tof}$ the time of flight between both stations. This results in a number $c\leq1$ where a value $\leq0$ describes an unphysical coincidence.
\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}
		\node (s1) [networknode] at (0, 0) {$s_1$};
		\node (s1r) [right=of s1] {};
		\node (s1b) [below=of s1] {};
		\node (s2) [networknode, below=of s1b] {$s_2$};
		\node (s3) [networknode, below right=of s1r] {$s_3$};
		\node (s3r) [below right=of s3] {};
		\node (s4) [networknode, below=of s3r] {$s_4$};
		
		\path[draw]
		(s1) edge node[left] {$c_{12}$} (s2)
		(s1) edge node[above] {$c_{13}$} (s3)
		(s2) edge node[left] {$c_{23}$} (s3)
		(s3) edge node[above right] {$c_{34}$} (s4)
		;
		\path[draw, dashed]
		(s1) edge node[below] {$c_{14}$} (s4)
		(s2) edge node[below] {$c_{13}$} (s4)
		;
		
		\draw[ultra thick, -> , >=latex] (4,0) -- ++(5,0) node[below] {$t$};
		\draw[dashed] (4.5,0.5) -- ++(0,-1) node[below] {$t_1$};
		\draw[dashed] (5.5,0.5) -- ++(0,-1) node[below] {$t_2$};
		\draw[dashed] (6.5,0.5) -- ++(0,-1) node[below] {$t_3$};
		\draw[dashed] (8,0.5) -- ++(0,-1) node[below] {$t_4$};
		
	\end{tikzpicture}
	\caption{Visualisation of four single events with possible coincidences}
	\label{fig:conflicts}
\end{figure} \\
In the case that multiple stations need to be compared, a complete graph needs to be calculated with edge weights equalling the score of the pair connected by this edge. An example of this construction is shown in figure \ref{fig:conflicts}.
There, \tikz \draw (0,0) -- (0.5,0); marks a physical time difference and \tikz \draw[dashed] (0,0) -- (0.5,0); marks an unphysical time difference. This leads to a conflict, since all stations $s_{1,2,3,4}$ have at least one physical coincidence time to at least one other station, but the data for $s_4$ only fits together with the data of $s_3$. This means that the whole coincidence is not physically viable, though an unknown number of partial coincidences can be.

In order to quantify this problem as one number, the unweighted plausibility score is introduced. Consider the graph with vertices $V = (s_1; s_2; s_3; s_4)$ from figure \ref{fig:conflicts} where the edges describe possible coincidences and the vertices detector stations. Only the set of edges $E = (c_{12}; c_{13}; c_{23}; c_{24})$ contains valid coincidences. The plausibility score of a full event with $n$ detector stations is then defined through
\begin{equation}
p = \frac{|E|}{\Delta_{n-1}}=\frac{2\cdot|E|}{n(n-1)}
\end{equation}
where $\Delta_n$ is the triangular number and $|E|$ the number of edges in the set $E$.

For a fully plausible coincidence event, this score is $1$, for the example in figure \ref{fig:conflicts} it is $p = \frac{4}{6}=\frac{2}{3}$.

In order to attempt to resolve this conflict additionally the weighted plausibility score $_wp$ is introduced:
\begin{equation}
	_wp = \frac{\sum^{n}_{i}\sum^{n}_{j} c_{ij}}{\Delta_{n-1}}
\end{equation}

The goal in resolving conflicting data is to maximise $_wp$ and reach $p=1$. Without access to more data is is impossible to definitively resolve this conflict, however an approximation can be performed.

This approximation can be done through selectively removing the vertex $s_i$ with lowest weighted rank
\begin{equation}
_wrank(s_i) = \sum_{j}^{n}c_{ij}
\end{equation}
in the graph and recalculating $_wp$, this is repeated until $p=1$ is reached. Should this prove to be impossible without removing too many edges for the purpose of preserving potentially useful data the process is cancelled and the whole event is accepted tentatively.

\subsection{Reconstruction of possible primary incident angles} \label{sec:reconstruction}
Through the assumptions shown in figure \ref{fig:angle-assumptions}, the possible source directions of a primary particle can be reduced. There, the geometry of a coincidence with $n=2$ is shown.
\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}
		\fill (0,0) coordinate(det1) circle(0.1);
		\fill (6,0) coordinate(det2) circle(0.1);
		\draw (det2) circle(1);
		\draw (det2) -- ++(125:0.7) node[right] {$\ell$} -- ++(125:6.4) coordinate(center);
		\draw[dashed] (det2) ++(125:1) ++ (215:2) -- ++(35:4) node[right] {tangent};
		\draw (det2) ++ (125:1) arc(-55:-35:6.1) arc(-35:-125:6.1) node[left] {shower front};
		\draw (center) -- (det1) -- (det2);
		\draw (det2) ++(125:1) -- (det1);
		\draw (det2) ++(125:1) -- ++(0,1) -- ++(0,-2);
		
		\draw (det1) -- ++(0,-0.9) coordinate(det1b) -- ++(0,-0.1);
		\draw (det2) -- ++(0,-0.9) coordinate(det2b) -- ++(0,-0.1);
		
		\draw[<->] (det2b) -- (det1b);
		\node[above] at ($(det1b)!0.5!(det2b)$) {$d$};
		\node[above left] at ($(det1)!0.5!(center)$) {$r$};
		
		\draw[<->] (center) ++(-55:2) arc(-55:-108:2) node[midway, above] {$\delta$};
		\draw[<->] (det2) ++(125:2) arc(125:90:1) node[midway, above] {$\alpha$};
		\draw[<->] (det2) ++(125:2) arc(125:189:1) node[midway, left] {$\gamma$};
		\draw[<->] (det1) ++(0:1) arc(0:72:1) node[midway, above right] {$\phi$};
		\draw[<->] (det1) ++(0:3) arc(0:8.584336297778657:3) node[midway, right] {$\beta$};
		\draw[<->] (det1) ++(8.584336297778657:3) node[above] {$s$};
		
	\end{tikzpicture}
	\caption{Assumption for possible incidence angles}
	\label{fig:angle-assumptions}
\end{figure} \\
Since she shower front can be simplified as a spherical section and the propagation speed can be assumed to be near the speed of light, two spheres with a shared tangent can be constructed. One spherical surface is the shower front, the other is a sphere around the detector which had the later event timing. Its radius $\ell$ is equal to the propagation time of light for the coincidence time. Through geometrical analysis of this arrangement, the Radius and angle pair can be derived as a function of the angle $\alpha$. This creates a curve in the plane on which the primary interaction must have taken place. Due to the symmetry of this arrangement however, in 3-D space, this curve becomes a rotational surface. \\
In the case of a coincidence with $n>2$ multiple curves can be calculated relative to the same root detector. This allows for the intersection points of each rotational surface to be calculated, which results in a reduced possible origin area for the primary interaction. \\
Given that the shower front is not a complete spherical surface but only a spherical section, the possible origin directions can be reduced with this approach. In the case of higher coincidence numbers, the possible direction can be reduced further. Additionally to the possible directions, this approach also provides a lower limit for the shower radius and footprint radius, suggesting a minimum Particle energy.
Calculating the angles $\beta$ and $\gamma$ and length $s$, we get the equations
\begin{equation*}
	\beta = \arctan\left(\frac{\ell\cdot\cos\alpha}{d - \ell\sin\alpha}\right),
\end{equation*}
\begin{equation*}
	\gamma = \frac{\pi}{2} - \alpha + \beta
\end{equation*}
and
\begin{equation*}
	s = \sqrt{\left(l\cdot\cos\hspace{-2pt}\left(\alpha\right)\right)^2 + \left(d - l\cdot\sin\left(\alpha\right)\right)^2} = \sqrt{l^2 + d^2 - 2dl\sin\left(\alpha\right)}.
\end{equation*}
With those, the polar coordinates $(\phi, r)$ can be calculated with equations \ref{eq:phi} and \ref{eq:r}.
\begin{equation}\label{eq:phi}
	\phi = \gamma + \beta = \frac{\pi}{2} - \alpha + 2\cdot\beta
\end{equation}
\begin{equation}\label{eq:r}
	r = \frac{s}{2\cdot\cos\left(\gamma\right)} = \frac{\sqrt{l^2 + d^2 - 2{\cdot}d{\cdot}l{\cdot}\sin\left(\alpha\right)}}{2\cdot\sin\left(\alpha - \beta\right)}
\end{equation}


Figure \ref{fig:reconstruction_example} shows an example for possible combinations of $r$ and $\phi$ as calculated above for a detector pair with distance of $3.4\,\text{km}$ and a coincidence time of $7.37\,\mu\text{s}$. Following the curve, the free parameter $\alpha$ is varied. The minimum possible distance is reached when $\alpha=\frac{\pi}{2}$, since then the center of the constructed circle in figure \ref{fig:angle-assumptions} lies directly on the line between both detectors. As $\alpha$ approaches $0$, the possible radius tends to infinity and $\phi$ tends to a stationary value $\phi_\infty$.
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.4\linewidth]{data/example_plot_vertical}
	\caption{Plot of an example to reconstruct the possible direction of incident primary particle}
	\label{fig:reconstruction_example}
\end{figure}
\begin{equation*}
	\begin{aligned}
		\lim_{\alpha\rightarrow0}r\left(\alpha\right) &= \infty\\
		\lim_{\alpha\rightarrow0}\phi\left(\alpha\right) &= \phi_\infty
	\end{aligned}
\end{equation*}
Noteworthy is that the possible values for $\alpha$ are constrained by a maximum value for $\delta$ due to a maximum shower footprint on earth. Adjusting for that, a lower limit for the radius r can be calculated iteratively through equation \ref{eq:delta_alpha}.
\begin{equation}\label{eq:delta_alpha}
	\delta = \pi - 2\cdot\gamma = 2\cdot\alpha - 2\cdot\arctan\left(\frac{\ell\cdot\cos\alpha}{d - \ell\sin\alpha}\right)
\end{equation}
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.4\linewidth]{data/example_plot_vertical_constrained}
	\caption{Possible incident angles and radii constrained to a maximum possible angle $\delta_{max}$}
	\label{fig:reconstruction_example_constrained}
\end{figure}
Figure \ref{fig:reconstruction_example_constrained} shows the same plot as figure \ref{fig:reconstruction_example} but with a constrained angle $\delta_{max} = \frac{\pi}{4}$.

Due to the inherent rotational symmetry of the system around the connecting straight line between both detectors, the curve shown in figures \ref{fig:reconstruction_example} and \ref{fig:reconstruction_example_constrained} show the outline of a rotational body with rotational axis equal to the connecting line. This permits a projection of the curve onto the ground in either direction. Doing this, the curves for all pairs involving a reference detector station can be calculated and projected onto the same plot, aligned according to the real world positions.
\begin{figure}[ht!]
	\centering
	\includegraphics[width=0.4\linewidth]{data/example_plot_ground}
	\caption{Ground plot for a coincidence with $n=3$.}
	\label{fig:reconstruction_example_ground}
\end{figure}\\
Figure \ref{fig:reconstruction_example_ground} shows this construction for a coincidence $n=3$, where the reference detector is located in the center and both other detectors are located towards the right. The real world distance between the reference station and station1 is $3.4\,\text{km}$, between the reference and station2 $2\,\text{km}$.
It can be seen that the curves overlap in the bottom half of the plot, indicating a possible origin region for the primary interaction.


Though due to the fact that the space of possible origin points is a rotational body, the cross section between both curves is a region in 3D space.
\section{Program layout}
The analysis program uses a data driven pipeline design for efficient execution. This is an approach where the processing units in the software do not continuously poll for data but only get called once data is available. Though for time critical applications, a maximum waiting time is defined after which the processing unit is invoked.

Apart from processing all events, it takes over the task of supervision of itself and all detector stations. For the purpose of keeping track of internal changes and changes in detector station status, a trigger system is employed in order to receive status updates outside of the application.
Periodically it stores runtime information and detector states in a database.
An overview of the program layout for the real-time analysis is shown in Figure \ref{fig:programlayout}, the parts marked with section numbers are described in detail in their respective sections.
\begin{figure}[h!]
	\centering
	\begin{tikzpicture}[->]
		\node (source) [draw, terminal,minimum height=1cm] {Event source};
		\node (logsource) [left=of source, draw, terminal,minimum height=1cm] {Station log source};
		\node (supervision) [below=of source, draw, process,minimum height=1cm] {Station supervision (\ref{subsec:station-s})};
		\node (supervision2) [below=of supervision, draw, process,minimum height=1cm] {Time-base supervision (\ref{subsec:timebase-s})};
		\node (filter) [below=of supervision2, draw, process,minimum height=1cm] {Coincidence filter (\ref{subsec:coincidence-f})};
		\node (analysis) [right=of filter, draw, process,minimum height=1cm] {Coincidence analysis (\ref{subsec:coincidence-s})};
		\node (sink) [below=of filter, draw, terminal,minimum height=1cm] {Event Sink};

		\node (criterium) [left=of filter, draw, predproc,minimum height=1cm] {Coincidence criterium};
		
		\draw (logsource) |- (supervision);
		\draw (source) -- (supervision);
		\draw (supervision) -- (supervision2);
		\draw (supervision2) -- (filter);
		\draw (filter) -- (sink);
		\draw (filter) -- (analysis);
		\draw (supervision) -| (analysis);
		
		\draw[<->] (criterium) -- (filter);
	\end{tikzpicture}
	\caption{Program layout}
	\label{fig:programlayout}
\end{figure} \\

The station log source and event source are abstract classes which can be implemented through multiple different protocols, though at the moment only a \acrshort{mqtt} implementation is used. The same is true for the Even Sink class, though there are three distinct implementations available. The first is a sink for use with an influxDB database which is used per default. Additionally there is a debugging sink which uses text output onto the console and the third is a sink to \acrshort{mqtt} which can be used if the application should be used as an instance for a local arrangement for a few detectors. This local instance then sends the processed data along to the next instance, effectively performing a preprocessing step for dense local arrangements.
\subsection{Station supervision}\label{subsec:station-s}
The station supervision tracks all currently active detector stations and classifies them according to reliable and unreliable data states.
Additionally it augments each event with the location and user data which is not provided with the default event messages.
\begin{figure}[h!]
	\centering
	\begin{tikzpicture}[->]
		\node (start) at (0,0) {};
		\node (terminal1) [below=of start,draw, terminal] {event input};
		\node (predproc1) [below=of terminal1, draw, predproc, align=left] {calculate event rate};
		\node (decide1) [below=of predproc1, draw, decision] {$\sigma\geq{k}\cdot\mu$};
		\node (terminal2) [right=of start, draw, terminal] {station log input};
		\node (decide2) [below right=of terminal2, draw, decision] {$\bar{f}_{loc}\geq1$};
		\node (decide3) [right=of predproc1, draw, decision] {$\bar{f}_{time}\geq1$};
		\node (predproc2) [below=of decide1, draw, terminal, align=left] {Mark station unreliable};
		
		
		\draw (terminal1) -- (predproc1);
		\draw (predproc1) -- (decide1);
		\draw (decide1) -- (predproc2);
		\draw (terminal2) -| (decide2);
		\draw (terminal1) -| (decide3);
		\draw (decide2) |- (predproc2);
		\draw (decide3) |- (predproc2);
	\end{tikzpicture}
	\caption{Criteria for detector station reliability}
	\label{fig:station_reliability}
\end{figure}
Figure \ref{fig:station_reliability} shows the decision process how each station is determined to be reliable. Each event is analysed and the mean event rate as well as the standard deviation of the rate is calculated continuously. If $\sigma\geq{k}\cdot\mu$ is true, where $\sigma$ is the standard deviation of the rate, $\mu$ the mean rate and $k$ a constant, the detector station is determined to have a highly unstable rate and is excluded from contributing events to the analysis.

Additionally two more factors can determine the reliability of a station. Those factors are a normed so that a value of higher than 1 causes an unreliability mark.
$\bar{f}_{time}$ is the mean time accuracy and $\bar{f}_{loc}$ the mean location precision of the \acrshort{gnss} receiver.

The time accuracy is determined through the detector station itself and results from different factors such as the \acrshort{gnss} signal quality.
The location precision is calculated through
\begin{equation*}
loc = dop\cdot\sqrt{h_{acc}^2 + v_{acc}^2}
\end{equation*}
where $dop$ is the delusion of precision, $h_{acc}$ the horizontal and $v_{acc}$ the vertical accuracy of the \acrshort{gnss} receiver. All those values are also determined in each detector station for itself.

For all determining factors, a hysteresis is used in order to provide a more stable status of each detector station.
\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}[->]
		\node (terminal1) at (0,0) [draw, terminal] {event input};
		\node (decide1) [below=of terminal1, draw, decision] {detector known};
		\node (decide2) [below=of decide1, draw, decision] {detector reliable};
		\node (decide3) [below=of decide2, draw, decision] {$f_{time}\gg1$};
		\node (predproc1) [below=of decide3, draw, predproc, align=left] {Add location info};
		\node (terminal2) [below=of predproc1, draw, terminal] {pass to coincidence filter};
		
		\node (decide1r) [right=of decide1] {no};
		\node (decide2r) [right=of decide2] {no};
		\node (decide3r) [right=of decide3] {yes};
		
		\node (terminal3) [right=of decide2r, draw, terminal] {discard event};
		
		
		
		\draw (terminal1) -- (decide1);
		\draw (decide1) -- (decide2);
		\draw (decide2) -- (decide3);
		\draw (decide3) -- (predproc1);
		\draw (predproc1) -- (terminal2);
		\draw (decide1) -- (decide1r) -| (terminal3);
		\draw (decide2) -- (decide2r) -- (terminal3);
		\draw (decide3) -- (decide3r) -| (terminal3);
	\end{tikzpicture}
	\caption{Path of an event through the station supervisor}
	\label{fig:event_station_supervisor}
\end{figure}
In figure \ref{fig:event_station_supervisor} the path of an event through the station supervisor is shown. There, only events which can be attributed to a reliable detector are accepted. Additionally, events where the time accuracy reaches extreme values are automatically discarded, since the method shown before in figure \ref{fig:station_reliability} has some inertia. This can cause single events with extremely inaccurate timestamps to artificially increase the time-base to extreme values.
\subsection{Time-base supervision}\label{subsec:timebase-s}
Since the detector network is so widely distributed, network lag and outages can introduce considerate deviations in arrival times between event messages from different detector stations. Consider the scenario shown in figure \ref{fig:network-topology}. There detector stations $A$, $B$ and $C$ all have different network delays to the server and so the event timestamps marked with $t_{A,B,C}$ have different arrival times at the server marked as $t'_{A,B,C}$. That necessitates a considerably larger sample interval for the coincidence determination than the expected coincidence interval.
\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}
		\node (server) [networknode] at (6.5,5) {Server};
		\node (serverbl) [below left=of server] {};
		\node (serverbr) [below right=of server] {};
		\node (servera) [above=of server] {};
		\node (a) [networknode, above=of servera] {A};
		\node (b) [networknode, below right=of serverbr] {B};
		\node (c) [networknode, below left=of serverbl] {C};
		
		\path[draw]
			(a) edge node[left] {$100\,\text{ms}$} (server)
			(b) edge node[above right] {$10\,\text{ms}$} (server)
			(c) edge node[left] {$35\,\text{ms}$} (server)
			;
			
			\draw[decoration={%
				discontinuity,
				amplitude=5,
				meta-segment length=2,
				segment length=3},
			decorate, ultra thick] (0,0) -- (10,0);
			\draw[ultra thick, ->] (10,0) -- (13,0) node[below] {$t$};
			\draw[dashed] (1,0.5) -- ++(0,-1) node[below] {$t_A$};
			\draw[dashed] (3,0.5) -- ++(0,-1) node[below] {$t_B$};
			\draw[dashed] (4,0.5) -- ++(0,-1) node[below] {$t_C$};
			
			\draw[dashed] (6,0.5) -- ++(0,-1) node[below] {$t_B'$};
			\draw[dashed] (7,0.5) -- ++(0,-1) node[below] {$t_C'$};
			\draw[dashed] (10,0.5) -- ++(0,-1) node[below] {$t_A'$};
	\end{tikzpicture}
	\caption{Network topology of detector network}
	\label{fig:network-topology}
\end{figure}

The time-base supervisor determines a baseline waiting interval by observing the maximum time difference between event timestamps over a certain sample time interval. A value of $2\,\text{s}$ proved experimentally to provide a good balance between runtime impact, stability and reaction time. In the case of a total network outage for one detector station however, the events will be buffered locally in the station and transmitted at a later time when the network connection has been re-established. This can mean delays of up to a few minutes and would lie outside the two second time-base and a loss of data would be the result. In order to mitigate this, an attempt to predict network outages is implemented by observing the current event rate in relation to the mean event rate over a long sample time. A factor is calculated through
\begin{equation*}
	f = max(1, \frac{\mu_{r} - r}{\sigma_{r}})
\end{equation*}
where $r$ is the current event rate, $\mu_{r}$ the mean rate and $\sigma_{r}$ the standard deviation of the rate over a long sample time. This factor is then relative to the expected event rate of the detector station and is always greater or equal to 1. This is calculated for all detector stations and the maximum value is used as a scaling factor for the previously described time-base.

The resulting time value can then be used by the coincidence filter as a timeout value for the construction of coincidence events.

\begin{figure}[ht!]
	\centering
	\begin{tikzpicture}
		\begin{axis}[area style, xlabel={$\Delta{t}\,[\text{ns}]$},ylabel={$n$},width=\linewidth,height=0.4\textheight,ymode=log]
			\addplot+[y=2,x=1,x filter/.code={\pgfmathparse{#1 - 1626681240}\pgfmathresult}] table {data/timeout.csv};
			\addplot+[y=3,x=1,x filter/.code={\pgfmathparse{#1 - 1626681240}\pgfmathresult}] table {data/timeout.csv};
		\end{axis}
	\end{tikzpicture}
%	\includegraphics[width=\linewidth]{data/dnp_timeout}
	\caption{Example of timebase and timeout factor over $6\,\text{hour}$ period}
	\label{fig:timeout-example}
\end{figure}
In figure \ref{fig:timeout-example} the timeout can be seen over a period over $6\,\text{hours}$. In orange is the timebase, in green the timeout with applied factor. Especially notable is the spike in timebase between $10:30$ and $10:40$.
\clearpage
\subsection{Coincidence filter}\label{subsec:coincidence-f}
In order to create the coincidence, the coincidence filter analyses each event and calculates the time differences to all other events currently in the local event buffer. It does so by utilising various coincidence criteria. One of them uses the distance based approach as described in section \ref{sec:coinc-calc}.
\begin{figure}[H]
	\centering
	\begin{tikzpicture}[->]
		\node (terminal1) at (0,0) [draw, terminal] {START};
		\node (decide1) [below=of terminal1, draw, decision] {constructor available};
		\node (process1) [below=of decide1, draw, process, align=left] {select next constructor};
		\node (decide2) [below=of process1, draw, decision] {criterium met};
		\node (decide3) [right=of process1, draw, decision] {queue empty};
		\node (process2) [below left=of decide2, draw, process] {add constructor to queue};
		\node (process3) [below right=of decide3, draw, process] {create new constructor};
		\node (process4) [below=of decide3, draw, process] {add event to constructor};
		
		\node (terminal2) [below=of process4, draw, terminal] {END};
		
		\node (decide1r) [right=of decide1] {no};
		\node (decide2l) [left=of decide2] {no};
		\node (decide3r) [right=of decide3] {yes};
		
		
		\draw (terminal1) -- (decide1);
		\draw (decide1) -- (process1);
		\draw (process1) -- (decide2);
		\draw (decide2) |- (process2);
		\draw (process2) |- (decide1);
		\draw (decide2) -- (decide2l) |- (decide1);
		\draw (decide1) -- (decide1r) -| (decide3);
		
		\draw (decide3) -- (decide3r) -| (process3);
		
		\draw (decide3) -- (process4);
		\draw (process3) |- (terminal2);
		\draw (process4) -- (terminal2);
	\end{tikzpicture}
	\caption{Flow of an event through the coincidence filter}
	\label{fig:coincidence-flow}
\end{figure}
The local event buffer uses so called event constructors. Those are objects which have the sole purpose of keeping the event information, holding the currently valid timeout period and the timestamp of when they were created. The flowchart in figure \ref{fig:coincidence-flow} shows the process when a new event arrives in the coincidence filter. All currently known event constructors are iterated through and checked for a positive fit with the current event. In the case of a positive match, the constructor is added to a queue and the loop continues until it doesn't have any more constructors to check. \\
After the last constructor has been passed, all constructors in the queue are combined to one joined constructor. This happens if the event bridges multiple unrelated constructors and thus the result is automatically classified as a conflicting coincidence. In the case that the queue is empty, the event does not match any constructors and so a new one is created for the single event.
\begin{figure}[H]
	\centering
	\begin{tikzpicture}[->]
		\node (terminal1) at (0,0) [draw, terminal] {START};
		\node (decide1) [below=of terminal1, draw, decision] {constructor available};
		\node (process1) [below=of decide1, draw, process, align=left] {select next constructor};
		\node (process2) [below=of process1, draw, process, align=left] {update timeout value};
		\node (decide2) [below=of process2, draw, decision] {timed out};
		\node (process3) [below=of decide2, draw, process] {commit coincidence};
		
		\node (decide1r) [right=of decide1] {no};
		\node (decide2l) [left=of decide2] {no};
		
		\node (terminal2) [right=of decide1r, draw, terminal] {END};
		
		
		\draw (terminal1) -- (decide1);
		\draw (decide1) -- (process1);
		\draw (process1) -- (process2);
		\draw (process2) -- (decide2);
		\draw (decide2) -- (process3);
		\draw (process3) -- ++(-4,0) |- (decide1);
		\draw (decide1) -- (decide1r) -- (terminal2);
		\draw (decide2) -- (decide2l) |- (decide1);
	\end{tikzpicture}
	\caption{Timeout update and committing of event constructors}
	\label{fig:event-constructors}
\end{figure}
After a certain time, the constructors need to be send off to the next station. This is done regularly by checking all constructors if their timeout has been reached. The flow chart in figure \ref{fig:event-constructors} shows how this is done. In the same process, each constructor is also updated with the latest timeout value.
\begin{figure}[ht!]
\centering
\includegraphics[width=\linewidth]{data/dnp_rates}
\caption{Example of incoming and outgoing event rate over $6\,\text{hour}$ period}
\label{fig:rates-example}
\end{figure}
\begin{figure}[ht!]
\centering
\includegraphics[width=\linewidth]{data/dnp_buffer}
\caption{Example of event buffer size over $6\,\text{hour}$ period}
\label{fig:rates-buffer}
\end{figure}
Figures \ref{fig:rates-example} and \ref{fig:rates-buffer} show the result of an increased timeout value as shown in the example in figure \ref{fig:timeout-example}. Figure \ref{fig:rates-buffer} shows the buffer size rise in direct relation to the increased timeout value just after $10:30$. This in turn causes a drop immediately followed by an increase in outgoing coincidence events as visible in the orange line in figure \ref{fig:rates-example}. Though due to the inherent statistical nature of the number of coincidences, the outgoing rate plot is much less clear than the other plots.
\clearpage
\subsection{Coincidence analysis}\label{subsec:coincidence-s}
The coincidence analysis is used to collect useful statistics mainly about detector station pair coincidence rates and histograms. It receives all coincidence events and has knowledge of all current detector stations. \\
With this information it creates a graph of all detector pairs where it tracks the event times and numbers for each pair. Though due to the large number of possible pairs in the number of detector stations, this needs to be done carefully in order to not use too much system memory. The number of pairs out of $n$ detectors can be calculated through the binomial coefficient which in the specific case for $k = 2$ can be calculated with
\begin{equation}
	{n \choose k} = \frac{n!}{k!\cdot\left(n - k\right)!} = \frac{1}{2}\left(n^2 - n\right) = \Delta_{n-1}.
\end{equation}
Which is the same definition for the number of edges in a complete graph. In memory, this construct can be stored as an upper triangular matrix with no diagonal entries.

Each edge in the then graph represents the number of coincidences of the associated detector pair and contains a histogram over a sample interval of $24\,\text{hours}$. After the sample interval is elapsed, all current histograms are stored to the disk and the structure in memory is reset.
\clearpage
\section{Conclusion and outlook}
This thesis described the possibility and implementation of a real-time system to analyse data from a loose network of scintillator detectors. A real-time system is preferable to post-analysis due to the large amount of data to be processed.
\clearpage

\makeback
\end{document}
